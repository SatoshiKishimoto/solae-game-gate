<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Solae Games</title>

  <meta name="description" content="Solae official mini games. Start after the ad is shown." />
  <meta property="og:title" content="Solae Games" />
  <meta property="og:description" content="Solae official mini games. Start after the ad is shown." />
  <meta property="og:type" content="website" />

  <style>
    :root{--bg:#0b0f1a;--card:#121a2b;--text:#fff;--muted:#aab3d6;--blue:#2563eb;--danger:#ff5c5c}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:grid;place-items:center}
    .wrap{width:min(560px,92vw);padding:18px}

    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .logoLink{display:inline-flex;align-items:center;gap:10px;text-decoration:none}
    .logo{height:34px;display:block;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
    .brand{font-weight:900;letter-spacing:.3px}
    .topRight{display:flex;align-items:center;gap:10px}
    .status{font-size:12px;color:var(--muted);white-space:nowrap}
    .lang{display:inline-flex;border:1px solid rgba(255,255,255,.14);border-radius:999px;overflow:hidden}
    .lang button{
      border:0;background:transparent;color:var(--muted);
      padding:6px 10px;font-weight:900;cursor:pointer;font-size:12px
    }
    .lang button.active{background:rgba(255,255,255,.10);color:#fff}

    .box{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:16px 14px;
      box-shadow:0 16px 40px rgba(0,0,0,.30)
    }

    h2{margin:0 0 6px;font-size:18px}
    p{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.6}

    #ad-area{
      min-height:140px;border-radius:14px;background:rgba(255,255,255,.06);
      border:1px dashed rgba(255,255,255,.18);
      display:flex;align-items:center;justify-content:center;
      color:#7b86b3;font-weight:900;margin:10px 0 14px; padding:12px; text-align:center;
      position:relative; overflow:hidden;
    }

    .pulse{display:inline-flex;align-items:center;gap:10px;color:#9aa6d6;font-weight:900}
    .dot{width:8px;height:8px;border-radius:999px;background:#9aa6d6;opacity:.35;animation:pulse 1.1s infinite}
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.30s}
    @keyframes pulse{0%{transform:translateY(0);opacity:.25}50%{transform:translateY(-2px);opacity:.95}100%{transform:translateY(0);opacity:.25}}

    #count{font-size:46px;font-weight:1000;text-align:center;margin:10px 0 12px}
    .btn{width:100%;border:0;border-radius:14px;padding:14px 16px;font-size:16px;font-weight:1000;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#3b82f6,var(--blue));color:#fff}
    .btn.secondary{background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(255,255,255,.12)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .row .btn{flex:1}

    .err{color:var(--danger);font-weight:900;font-size:12px;margin-top:10px;line-height:1.5;white-space:pre-line}
    .hide{display:none}
    .small{font-size:12px;color:var(--muted)}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;color:var(--muted)
    }
  </style>

  <!-- ✅ Monetag（あなたの zone のタグ） -->
  <script src="https://quge5.com/88/tag.min.js" data-zone="213013" async data-cfasync="false"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <a class="logoLink" href="https://solae.my.canva.site/" target="_blank" rel="noopener">
        <img class="logo" src="https://lh3.googleusercontent.com/d/1ejao3rdNer6UppKTaAAFlC3ILTR0RcUP" alt="Solae">
        <div class="brand">Solae Games</div>
      </a>

      <div class="topRight">
        <div class="lang" aria-label="Language">
          <button id="btnJA" type="button">JA</button>
          <button id="btnEN" type="button">EN</button>
        </div>
        <div class="status" id="statusTop">Gate</div>
      </div>
    </div>

    <div class="box">
      <h2 id="headline">…</h2>
      <p id="subtext">…</p>

      <div id="ad-area">
        <div id="ad-wait" class="pulse">
          <span class="badge" id="adBadge">…</span>
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
      </div>

      <div id="count">5</div>

      <!-- ✅ START統一 -->
      <button id="go" class="btn primary hide">▶ START</button>

      <div id="waitHint" class="small hide" style="margin-top:10px;text-align:center"></div>

      <div class="row">
        <button id="back" class="btn secondary">…</button>
        <button id="copy" class="btn secondary">…</button>
      </div>

      <div id="err" class="err hide"></div>
    </div>
  </div>

  <script>
    // =============================
    // i18n
    // =============================
    const I18N = {
      ja: {
        gate: 'ゲート',
        waiting: '広告読み込み中…',
        ready: '開始できます',
        readyWait: '開始できます（広告待ち可）',
        moving: '移動中…',
        errTitle: 'エラー',
        head: 'ゲームを開始する前に…',
        sub: '広告の読み込み状況によっては、表示に少し時間がかかることがあります。',
        adLoading: '広告を読み込み中',
        waitHint: '広告の取得が遅れています。<br><b>待ってもOK</b>（最大15秒で自動解放）／<b>すぐ開始してもOK</b>',
        back: '← 戻る',
        copy: 'リンクをコピー',
        copied: 'コピーしました',
        copyFail: 'コピー失敗',
        noTo: '遷移先が指定されていません（URLの ?to= がありません）。',
        badLink: (m)=> 'リンクが不正です：' + m + '\\n例：?to=' + encodeURIComponent('https://script.google.com/macros/s/XXXXX/exec')
      },
      en: {
        gate: 'Gate',
        waiting: 'Loading ad…',
        ready: 'Ready',
        readyWait: 'Ready (you may wait for ad)',
        moving: 'Opening…',
        errTitle: 'Error',
        head: 'Before you start…',
        sub: 'Depending on your network, the ad may take a little longer to load.',
        adLoading: 'Loading ad',
        waitHint: 'Ad is taking longer than usual.<br><b>You can wait</b> (auto release within 15s) / <b>or start now</b>.',
        back: '← Back',
        copy: 'Copy link',
        copied: 'Copied',
        copyFail: 'Copy failed',
        noTo: 'Missing destination (no ?to= in the URL).',
        badLink: (m)=> 'Invalid link: ' + m + '\\nExample: ?to=' + encodeURIComponent('https://script.google.com/macros/s/XXXXX/exec')
      }
    };

    const KEY_LANG = 'solae_lang';
    const btnJA = document.getElementById('btnJA');
    const btnEN = document.getElementById('btnEN');

    function detectDefaultLang(){
      const nav = (navigator.language || '').toLowerCase();
      return nav.startsWith('ja') ? 'ja' : 'en';
    }

    let lang = localStorage.getItem(KEY_LANG) || detectDefaultLang();
    if (!I18N[lang]) lang = 'en';

    function t(){ return I18N[lang]; }

    function applyLangUI(){
      btnJA.classList.toggle('active', lang==='ja');
      btnEN.classList.toggle('active', lang==='en');

      document.getElementById('headline').textContent = t().head;
      document.getElementById('subtext').textContent  = t().sub;
      document.getElementById('adBadge').textContent  = t().adLoading;
      document.getElementById('back').textContent     = t().back;
      document.getElementById('copy').textContent     = t().copy;
      document.getElementById('statusTop').textContent= t().gate;
      document.documentElement.lang = lang;
    }

    btnJA.addEventListener('click', ()=>{ lang='ja'; localStorage.setItem(KEY_LANG, lang); applyLangUI(); });
    btnEN.addEventListener('click', ()=>{ lang='en'; localStorage.setItem(KEY_LANG, lang); applyLangUI(); });

    applyLangUI();

    // =============================
    // Gate logic
    // =============================
    const MIN_WAIT = 5;
    const MAX_WAIT = 15;

    const ALLOWED_HOSTS = new Set(['script.google.com','script.googleusercontent.com']);
    const GATE_HOME = 'https://satoshikishimoto.github.io/solae-game-gate/';

    const params   = new URLSearchParams(location.search);
    const rawTo    = params.get('to');

    const goBtn    = document.getElementById('go');
    const countEl  = document.getElementById('count');
    const errEl    = document.getElementById('err');
    const backBtn  = document.getElementById('back');
    const copyBtn  = document.getElementById('copy');
    const statusTop= document.getElementById('statusTop');
    const waitHint = document.getElementById('waitHint');
    const adArea   = document.getElementById('ad-area');

    function setStatus(text){ statusTop.textContent = text; }

    function showError(msg){
      errEl.textContent = msg;
      errEl.classList.remove('hide');
      countEl.textContent = '—';
      countEl.style.opacity = .5;
      goBtn.classList.add('hide');
      waitHint.classList.add('hide');
      setStatus(t().errTitle);
    }

    function deepDecode(s){
      let out = (s ?? '').toString().trim();
      out = out.replace(/^["']|["']$/g, '');
      for (let i = 0; i < 3; i++){
        try{
          const dec = decodeURIComponent(out);
          if (dec === out) break;
          out = dec;
        }catch(e){ break; }
      }
      return out.trim();
    }

    function validateAndNormalize(urlStr){
      const u = new URL(urlStr);
      if (u.protocol !== 'https:' && u.protocol !== 'http:') throw new Error('URL must be http/https.');
      if (!ALLOWED_HOSTS.has(u.hostname)) throw new Error('Destination host is not allowed.');
      return u.toString();
    }

    function looksAdReady(){
      // 緩い判定：要素数が増えたら「来た可能性」
      return adArea.querySelectorAll('*').length > 3;
    }

    backBtn.addEventListener('click', () => {
      if (history.length > 1) history.back();
      else location.href = GATE_HOME;
    });

    copyBtn.addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText(location.href);
        const old = copyBtn.textContent;
        copyBtn.textContent = t().copied;
        setTimeout(() => copyBtn.textContent = t().copy, 1100);
      }catch(e){
        const old = copyBtn.textContent;
        copyBtn.textContent = t().copyFail;
        setTimeout(() => copyBtn.textContent = t().copy, 1100);
      }
    });

    if (!rawTo){
      setStatus(t().errTitle);
      showError(t().noTo);
    } else {
      let dest = null;
      try{
        const decoded = deepDecode(rawTo);
        dest = validateAndNormalize(decoded);
      } catch(e){
        showError(t().badLink(e?.message || String(e)));
      }

      if (dest){
        setStatus(t().waiting);

        let sec = MIN_WAIT;
        countEl.textContent = String(sec);

        const t1 = setInterval(() => {
          sec--;
          countEl.textContent = String(sec);

          if (sec <= 0) {
            clearInterval(t1);

            countEl.classList.add('hide');
            goBtn.classList.remove('hide');
            goBtn.disabled = false;

            if (!looksAdReady()){
              waitHint.innerHTML = t().waitHint;
              waitHint.classList.remove('hide');
              setStatus(t().readyWait);
            } else {
              waitHint.classList.add('hide');
              setStatus(t().ready);
            }

            const start = Date.now();
            const t2 = setInterval(() => {
              const elapsed = Math.floor((Date.now() - start) / 1000);
              const remaining = MAX_WAIT - MIN_WAIT - elapsed;

              if (looksAdReady()){
                waitHint.classList.add('hide');
                setStatus(t().ready);
                clearInterval(t2);
              } else if (remaining <= 0){
                setStatus(lang==='ja' ? '開始できます（広告が遅い可能性）' : 'Ready (ad may be delayed)');
                clearInterval(t2);
              }
            }, 500);

            goBtn.addEventListener('click', () => {
              setStatus(t().moving);
              location.href = dest;
            }, { once:true });
          }
        }, 1000);

        const mo = new MutationObserver(() => {
          if (looksAdReady()){
            waitHint.classList.add('hide');
            if (!errEl.classList.contains('hide')) return;
            if (goBtn.classList.contains('hide')) setStatus(lang==='ja' ? '広告表示準備OK' : 'Ad ready');
            else setStatus(t().ready);
          }
        });
        mo.observe(adArea, { childList:true, subtree:true });
      }
    }
  </script>
</body>
</html>
