<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Solae Games</title>

  <meta name="description" content="Solae公式ミニゲーム。広告表示後にゲームを開始できます。" />
  <meta property="og:title" content="Solae Games" />
  <meta property="og:description" content="Solae公式ミニゲーム。広告表示後にゲームを開始できます。" />
  <meta property="og:type" content="website" />

  <style>
    :root{--bg:#0b0f1a;--card:#121a2b;--text:#fff;--muted:#aab3d6;--blue:#2563eb;--danger:#ff5c5c}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:grid;place-items:center}
    .wrap{width:min(520px,92vw);padding:18px}

    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px
    }
    .logoLink{display:inline-flex;align-items:center;gap:10px;text-decoration:none}
    .logo{height:34px;display:block;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
    .brand{font-weight:900;letter-spacing:.3px}
    .topRight{font-size:12px;color:var(--muted);white-space:nowrap}

    .box{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:16px 14px;
      box-shadow:0 16px 40px rgba(0,0,0,.30)
    }

    h2{margin:0 0 6px;font-size:18px}
    p{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.6}

    #ad-area{
      min-height:120px;border-radius:14px;background:rgba(255,255,255,.06);
      border:1px dashed rgba(255,255,255,.18);
      display:flex;align-items:center;justify-content:center;
      color:#7b86b3;font-weight:800;margin:10px 0 14px; padding:10px; text-align:center
    }

    #count{font-size:46px;font-weight:1000;text-align:center;margin:10px 0 12px}
    .btn{width:100%;border:0;border-radius:14px;padding:14px 16px;font-size:16px;font-weight:1000;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#3b82f6,var(--blue));color:#fff}
    .btn.secondary{background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(255,255,255,.12)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .row .btn{flex:1}

    .err{color:var(--danger);font-weight:900;font-size:12px;margin-top:10px;line-height:1.5;white-space:pre-line}
    .hide{display:none}
    .small{font-size:12px;color:var(--muted)}
  </style>
  <script src="https://quge5.com/88/tag.min.js" data-zone="213013" async data-cfasync="false"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <!-- ✅ ロゴにリンク（Solaeサイトへ） -->
      <a class="logoLink" href="https://solae.my.canva.site/" target="_blank" rel="noopener">
        <img class="logo" src="https://lh3.googleusercontent.com/d/1ejao3rdNer6UppKTaAAFlC3ILTR0RcUP" alt="Solae">
        <div class="brand">Solae Games</div>
      </a>

      <!-- ✅ 右上はステータス表示だけ（タイトル扱いしない） -->
      <div class="topRight" id="statusTop">ゲート</div>
    </div>

    <div class="box">
      <h2 id="headline">ゲームを開始する前に…</h2>
      <p id="subtext">下の表示が終わったら「ゲームを始める」が押せます。</p>

      <!-- ✅ ここに広告タグ -->
      <div id="ad-area">
        広告エリア（ここにタグ）<br>
        <span class="small">※タグを入れない場合も動作します</span>
      </div>

      <div id="count">5</div>
      <button id="go" class="btn primary hide">▶ ゲームを始める</button>

      <div class="row">
        <button id="back" class="btn secondary">← 戻る</button>
        <button id="copy" class="btn secondary">リンクをコピー</button>
      </div>

      <div id="err" class="err hide"></div>

      <!-- ✅ 注意文は「表示しない」（必要ならここを復活） -->
      <!-- <div class="small" style="margin-top:10px;text-align:center">
        ※URL直打ち対策を強化したい場合は次に「トークン方式」に進めます。
      </div> -->
    </div>
  </div>

  <script>
    // =============================
    // 設定：許可する遷移先ドメイン
    // =============================
    const ALLOWED_HOSTS = new Set([
      'script.google.com',
      'script.googleusercontent.com'
    ]);

    const GATE_HOME = 'https://satoshikishimoto.github.io/solae-game-gate/';

    const params = new URLSearchParams(location.search);
    const rawTo = params.get('to');

    const goBtn = document.getElementById('go');
    const countEl = document.getElementById('count');
    const errEl = document.getElementById('err');
    const backBtn = document.getElementById('back');
    const copyBtn = document.getElementById('copy');
    const statusTop = document.getElementById('statusTop');

    function showError(msg){
      errEl.textContent = msg;
      errEl.classList.remove('hide');
      countEl.textContent = '—';
      countEl.style.opacity = .5;
      goBtn.classList.add('hide');
      statusTop.textContent = 'エラー';
    }

    function deepDecode(s){
      let out = (s ?? '').toString().trim();
      out = out.replace(/^["']|["']$/g, '');
      for (let i = 0; i < 3; i++){
        try{
          const dec = decodeURIComponent(out);
          if (dec === out) break;
          out = dec;
        }catch(e){
          break;
        }
      }
      return out.trim();
    }

    function validateAndNormalize(urlStr){
      const u = new URL(urlStr);
      if (u.protocol !== 'https:' && u.protocol !== 'http:') {
        throw new Error('URLが http/https ではありません。');
      }
      if (!ALLOWED_HOSTS.has(u.hostname)) {
        throw new Error('許可されていない遷移先です。');
      }
      return u.toString();
    }

    backBtn.addEventListener('click', () => {
      if (history.length > 1) history.back();
      else location.href = GATE_HOME;
    });

    copyBtn.addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText(location.href);
        const old = copyBtn.textContent;
        copyBtn.textContent = 'コピーしました';
        setTimeout(() => copyBtn.textContent = old, 1100);
      }catch(e){
        const old = copyBtn.textContent;
        copyBtn.textContent = 'コピー失敗';
        setTimeout(() => copyBtn.textContent = old, 1100);
      }
    });

    if (!rawTo){
      showError('遷移先が指定されていません（URLの ?to= がありません）。');
    } else {
      let dest = null;
      try{
        const decoded = deepDecode(rawTo);
        dest = validateAndNormalize(decoded);
      } catch(e){
        showError(
          'リンクが不正です：' + (e?.message || String(e)) + '\n' +
          '例：?to=' + encodeURIComponent('https://script.google.com/macros/s/XXXXX/exec')
        );
      }

      if (dest){
        statusTop.textContent = '待機中…';

        let sec = 5;
        countEl.textContent = String(sec);

        const t = setInterval(() => {
          sec--;
          countEl.textContent = String(sec);
          if (sec <= 0) {
            clearInterval(t);
            countEl.classList.add('hide');
            goBtn.classList.remove('hide');
            goBtn.disabled = false;
            statusTop.textContent = '開始できます';
          }
        }, 1000);

        goBtn.addEventListener('click', () => {
          statusTop.textContent = '移動中…';
          location.href = dest;
        }, { once:true });
      }
    }
  </script>
</body>
</html>
